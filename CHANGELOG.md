## From `1.27.6` to `1.28.7`

#### Kubernetes v1.28: Planternetes

<img src="https://github.com/alta3/kubernetes-the-alta3-way/assets/116113/e0f645cb-4959-4432-a7e5-a0bacea0ed89" width="200" height="200" />

- https://github.com/kubernetes/kubernetes/releases/tag/v1.28.0
- https://kubernetes.io/blog/2023/08/15/kubernetes-v1-28-release/
- https://kubernetes.io/docs/reference/using-api/deprecation-guide/#v1-29

## Supporting component releases

```yaml
k8s_version: "1.28.7"        # https://kubernetes.io/releases/#release-v1-28
etcd_version: "3.5.12"       # https://github.com/etcd-io/etcd/releases
cni_version: "1.4.1"         # https://github.com/containernetworking/plugins/releases 
containerd_version: "1.7.14" # https://github.com/containerd/containerd/releases
cri_tools_version: "1.28.0"  # https://github.com/kubernetes-sigs/cri-tools/releases
cfssl_version: "1.6.5"       # https://github.com/cloudflare/cfssl/releases
runc_version: "1.1.9"        # https://github.com/opencontainers/runc/releases
coredns_version: "1.11.12"   # https://github.com/coredns/coredns/releases
calico_version: "3.27.2"     # https://github.com/projectcalico/calico/releases
helm_version: "3.14.3"       # https://github.com/helm/helm/releases
gvisor_version: "latest"     # https://github.com/google/gvisor/releases
```
## From `1.26.4` to `1.27.6`

#### Kubernetes v1.27: Chill Vibes

<img src="https://github.com/alta3/kubernetes-the-alta3-way/assets/116113/e892eb51-2ca1-4c37-8ed3-567ddab315ee" width="200" height="200" />

- https://github.com/kubernetes/kubernetes/releases/tag/v1.27.1
- https://kubernetes.io/blog/2023/04/11/kubernetes-v1-27-release/
- https://kubernetes.io/docs/reference/using-api/deprecation-guide/#v1-27

```yaml 
k8s_version: "1.27.6"        # https://kubernetes.io/releases/#release-v1-27                          etcd_version: "3.5.9"        # https://github.com/etcd-io/etcd/releases                             
cni_version: "1.3.0"         # https://github.com/containernetworking/plugins/releases 
containerd_version: "1.7.6"  # https://github.com/containerd/containerd/releases       
cri_tools_version: "1.27.1"  # https://github.com/kubernetes-sigs/cri-tools/releases   
cfssl_version: "1.6.4"       # https://github.com/cloudflare/cfssl/releases            
runc_version: "1.1.9"        # https://github.com/opencontainers/runc/releases         
coredns_version: "1.11.1"    # https://github.com/coredns/coredns/releases             
calico_version: "3.26.3"     # https://github.com/projectcalico/calico/releases        
helm_version: "3.13.0"       # https://github.com/helm/helm/releases                   
gvisor_version: "latest"     # https://github.com/google/gvisor/releases               
```   

## from `1.25.5` to `1.26.4`

#### Kubernetes v1.25: Combiner

<img src="https://user-images.githubusercontent.com/116113/207213140-2d7827ca-f8dc-45b2-9fe7-c9f4c8fe0350.png" width="200" height="200" />

- https://github.com/kubernetes/kubernetes/releases/tag/v1.26.4
- https://kubernetes.io/blog/2022/12/09/kubernetes-v1-26-release

```yaml
k8s_version: "1.26.5"        # https://kubernetes.io/releases/#release-v1-26
etcd_version: "3.5.9"        # https://github.com/etcd-io/etcd/releases
cni_version: "1.3.0"         # https://github.com/containernetworking/cni/releases
containerd_version: "1.7.1"  # https://github.com/containerd/containerd/releases
cri_tools_version: "1.26.1"  # https://github.com/kubernetes-sigs/cri-tools/releases
cfssl_version: "1.6.4"       # https://github.com/cloudflare/cfssl/releases
runc_version: "1.1.7"        # https://github.com/opencontainers/runc/releases
coredns_version: "1.10.1"    # https://github.com/coredns/coredns/releases
calico_version: "3.25.1"     # https://github.com/projectcalico/calico/releases
helm_version: "3.12.0"       # https://github.com/helm/helm/releases
gvisor_version: "latest"     # https://github.com/google/gvisor/releases
```

Supporting release links
- https://github.com/etcd-io/etcd/releases/tag/v3.5.9 
- https://github.com/containernetworking/cni/releases/tag/v1.1.2
- https://github.com/containerd/containerd/releases/tag/v1.7.1 
- https://github.com/kubernetes-sigs/cri-tools/releases/tag/v1.26.1 
- https://github.com/cloudflare/cfssl/releases/tag/v1.6.4 
- https://github.com/opencontainers/runc/releases/tag/v1.1.7 
- https://github.com/coredns/coredns/releases/tag/v1.10.1 
- https://github.com/projectcalico/calico/releases/tag/v3.25.1 
- https://github.com/helm/helm/releases/tag/v3.12.0 

## from `1.24.4` to `1.25.5`

#### Kubernetes v1.25: Combiner

<img src="https://user-images.githubusercontent.com/116113/188537177-16e36780-8cf1-43ea-9b15-cbfc2b9a9151.png" width="200" height="200" />

- https://github.com/kubernetes/kubernetes/releases/tag/v1.25.4
- https://kubernetes.io/blog/2022/08/23/kubernetes-v1-25-release/

```yaml
k8s_version: "1.25.5"        # https://kubernetes.io/releases/#release-v1-25
etcd_version: "3.5.6"        # https://github.com/etcd-io/etcd/releases
cni_version: "1.1.1"         # https://github.com/containernetworking/cni/releases
containerd_version: "1.6.12" # https://github.com/containerd/containerd/releases
cri_tools_version: "1.25.0"  # https://github.com/kubernetes-sigs/cri-tools/releases
cfssl_version: "1.6.3"       # https://github.com/cloudflare/cfssl/releases
runc_version: "1.1.4"        # https://github.com/opencontainers/runc/releases
coredns_version: "1.10.0"    # https://github.com/coredns/coredns/releases
calico_version: "3.24.5"     # https://github.com/projectcalico/calico/releases
helm_version: "3.10.2"       # https://github.com/helm/helm/releases
```

Supporting release links
- https://github.com/etcd-io/etcd/releases/tag/v3.5.6 
- https://github.com/containernetworking/cni/releases/tag/v1.1.1
- https://github.com/containerd/containerd/releases/tag/v1.6.12 
- https://github.com/kubernetes-sigs/cri-tools/releases/tag/v1.25.0 
- https://github.com/cloudflare/cfssl/releases/tag/v1.6.3 
- https://github.com/opencontainers/runc/releases/tag/v1.1.4 
- https://github.com/coredns/coredns/releases/tag/v1.10.0 
- https://github.com/projectcalico/calico/releases/tag/v3.24.5 
- https://github.com/helm/helm/releases/tag/v3.10.2 

## from `1.23.3` to `1.24.4`

``` yaml
k8s_version: "1.24.4"       # https://kubernetes.io/releases/#release-v1-24 
etcd_version: "3.5.4"       # https://github.com/etcd-io/etcd/releases
cni_version: "1.1.1"        # https://github.com/containernetworking/cni/releases
containerd_version: "1.6.8" # https://github.com/containerd/containerd/releases
cri_tools_version: "1.24.2" # https://github.com/kubernetes-sigs/cri-tools/releases
cfssl_version: "1.6.2"      # https://github.com/cloudflare/cfssl/releases
runc_version: "1.1.4"       # https://github.com/opencontainers/runc/releases
coredns_version: "1.9.3"    # https://github.com/coredns/coredns/releases
calico_version: "3.24.1"    # https://github.com/projectcalico/calico/releases
helm_version: "3.9.4"       # https://github.com/helm/helm/releases
```

### Re-baslined kubernetes-the-alta3-way changes to calico manifest

Source yaml: [v3.24.1 calcio-etcd.yaml](https://raw.githubusercontent.com/projectcalico/calico/v3.24.1/manifests/calico-etcd.yaml)

`diff calico-etcd.yaml roles/calico/templates/calico.yaml.j2`

```diff
47,49c47,50
<   # etcd-key: null
<   # etcd-cert: null
<   # etcd-ca: null
---
>   # alta3-the-hard-way managed item
>   etcd-key:  "{{ lookup('file', k8s_key_file ) | b64encode }}"
>   etcd-cert: "{{ lookup('file', k8s_pem_file ) | b64encode }}"
>   etcd-ca:   "{{ lookup('file', ca_pem_file  ) | b64encode }}"
60c61,62
<   etcd_endpoints: "http://<ETCD_IP>:<ETCD_PORT>"
---
>   # alta3-the-hard-way managed item
>   etcd_endpoints: "{{ calico_etcd_endpoints }}"
63,65c65,68
<   etcd_ca: ""   # "/calico-secrets/etcd-ca"
<   etcd_cert: "" # "/calico-secrets/etcd-cert"
<   etcd_key: ""  # "/calico-secrets/etcd-key"
---
>   # alta3-the-hard-way managed item
>   etcd_ca:   "/calico-secrets/etcd-ca"
>   etcd_cert: "/calico-secrets/etcd-cert"
>   etcd_key:  "/calico-secrets/etcd-key"
74c77,78
<   veth_mtu: "0"
---
>   # alta3-the-hard-way managed item
>   veth_mtu: "{{ calico_veth_mtu }}"
269c273,274
<           image: docker.io/calico/cni:v3.24.1
---
>           # alta3-the-hard-way managed item
>           image: docker.io/calico/cni:v{{ calico_version }}
315c320,321
<           image: docker.io/calico/node:v3.24.1
---
>           # alta3-the-hard-way managed item
>           image: docker.io/calico/node:v{{ calico_version }}
341c347,348
<           image: docker.io/calico/node:v3.24.1
---
>           # alta3-the-hard-way managed item
>           image: docker.io/calico/node:v{{ calico_version }}
389a397,399
>             # alta3-the-hard-way managed item
>             - name: IP_AUTODETECTION_METHOD
>               value: "can-reach=8.8.8.8"
419a430,432
>             # alta3-the-hard-way managed item
>             - name: CALICO_IPV4POOL_CIDR
>               value: "{{ cluster_cidr }}"
432a446,448
>             # alta3-the-hard-way managed item
>             - name: WAIT_FOR_DATASTORE
>               value: "true"
581c597
<           image: docker.io/calico/kube-controllers:v3.24.1
---
>           image: docker.io/calico/kube-controllers:v{{ calico_version }}
```

### Removed depreciated kube-apiserver flag (RemoveSelfLink)
Observed error:
```
controller kube-apiserver[3805]: Error: invalid argument "RemoveSelfLink=false" for "--feature-gates" flag: cannot set feature gate RemoveSelfLink to false, feature is locked to true
```

Documentaton links:

- https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/
- https://github.com/kubernetes/enhancements/tree/master/keps/sig-api-machinery/1164-remove-selflink
- https://github.com/alta3/labs/issues/400

Fix:
```diff
roles/controller_install/templates/kube-apiserver.service.j2
-  --feature-gates=RemoveSelfLink=false \
```

### Removed dockershim-related kublet flags

Observed error:
```
node-1 kubelet[8760]: Error: failed to parse kubelet flag: unknown flag: --image-pull-progress-deadline
```

Documentation links:
- https://github.com/kubernetes/kubernetes/pull/106907
- https://github.com/kubernetes/kubernetes/pull/107094
- https://www.armosec.io/blog/kubernetes-version-1-24/

Fix:
```diff
roles/node_install/templates/kubelet.service.j2
-  --container-runtime=remote \
-  --network-plugin=cni \
-  --image-pull-progress-deadline=2m \
```

## from `1.18.0` to `1.23.3`

### Versions:

```
k8s_version: "1.23.3"       # https://kubernetes.io/releases/#release-v1-23
etcd_version: "3.5.1"       # https://github.com/etcd-io/etcd/releases/tag/v3.5.1
cni_version: "1.0.1"        # https://github.com/containernetworking/cni/releases/tag/v1.0.1
containerd_version: "1.5.9" # https://github.com/containerd/containerd/releases/tag/v1.5.9
cri_tools_version: "1.23.0" # https://github.com/kubernetes-sigs/cri-tools/releases/tag/v1.23.0
cfssl_version: "1.6.1"      # https://github.com/cloudflare/cfssl/releases/tag/v1.6.1
runc_version: "1.1.0"       # https://github.com/opencontainers/runc/releases/tag/v1.1.0
coredns_version: "1.9.0"    # https://github.com/coredns/coredns/releases/tag/v1.9.0
calico_version: "3.21.4"    # https://github.com/projectcalico/calico/releases/tag/v3.21.4
```

### Removed depricated kube-apiserver flag:

Observed error:
```
kube-apiserver[]: Error: unknown flag: --kubelet-https
```

Fix:
``` diff
# on master kub-apiserver failed with error:
roles/master_install/templates/kube-apiserver.service.j2
-  --kubelet-https=true \
```

### Update kube-scheduler configuration to the latest version

Observed error:
```
# on master kube-scheduler failed with error:
master-1 kube-scheduler[]: E0129 20:41:42.583894   16355 run.go:74] "command failed" err="no kind \"KubeSchedulerConfiguration\" is registered for version \"kubescheduler.config.k8s.io/v1alpha1\" in scheme \"k8s.io/kubernetes/pkg/scheduler/apis/config/scheme/scheme.go:30\""
```

Fix:

``` diff
roles/make_certs/templates/kube-scheduler.yaml.j2
-apiVersion: kubescheduler.config.k8s.io/v1alpha1
+apiVersion: kubescheduler.config.k8s.io/v1beta1
```

### New required service-account flags in kube-apiserver

Observed error:
```
master-1 kube-apiserver[]: E0129 20:48:36.178551   24811 run.go:74] "command failed" err="[service-account-issuer is a required flag, --service-account-signing-key-file and --service-account-issuer are required flags]"

```

`--service-account-signing-key-file string`

> Path to the file that contains the current private key of the service account token issuer. The issuer will sign issued ID tokens with this private key.

`--service-account-issuer strings`

> Identifier of the service account token issuer. The issuer will assert this identifier in "iss" claim of issued tokens. This value is a string or URI. If this option is not a valid URI per the OpenID Discovery 1.0 spec, the ServiceAccountIssuerDiscovery feature will remain disabled, even if the feature gate is set to true. It is highly recommended that this value comply with the OpenID spec: https://openid.net/specs/openid-connect-discovery-1_0.html. In practice, this means that service-account-issuer must be an https URL. It is also highly recommended that this URL be capable of serving OpenID discovery documents at {service-account-issuer}/.well-known/openid-configuration. When this flag is specified multiple times, the first is used to generate tokens and all are used to determine which issuers are accepted.


Fix: 

``` diff
roles/master_install/templates/kube-apiserver.service.j2
-  --service-account-key-file={{ deployed_kube_controller_manager_pem_file }} \
+  --service-account-key-file={{ deployed_service_account_pem_file }} \
+  --service-account-signing-key-file={{ deployed_service_account_key_file }} \
+  --service-account-issuer=https://{{ public_ip }}:6443 \
```

### scheduler configuration update (`v1beta2`)

Observed error:
```
master-1 kube-scheduler[]: E0129 22:46:36.663200   11913 run.go:74] "command failed" err="no kind \"KubeSchedulerConfiguration\" is registered for version \"kubescheduler.config.k8s.io/v1beta1\" in scheme \"k8s.io/kubernetes/pkg/scheduler/apis/config/scheme/scheme.go:30\""
Jan 29 22:46:36 master-1 systemd[1]: kube-scheduler.service: Main process exited, code=exited, status=1/FAILURE
```

Details: https://github.com/kelseyhightower/kubernetes-the-hard-way/issues/687

Fix:

With the latest k8s (1.23.2+) an update to the apiVersion for kubescheduler is required

``` diff
roles/make_certs/templates/kube-scheduler.yaml.j2
-apiVersion: kubescheduler.config.k8s.io/v1beta1
+apiVersion: kubescheduler.config.k8s.io/v1beta2
```

### rbac cluster role aututorization apiVersion update (`v1`)

Observed error:
```
error: unable to recognize rbac-clusterrole.yaml: no matches for kind "ClusterRole" in version "rbac.authorization.k8s.io/v1beta1"
```

Fix:

Kubernetes version `v1.23.1`+ no longer accepts `v1beta` for `rbac.authrization.k8s.io` version.
Update the rbac cluster role authorization configuration yaml to `v1`

``` diff
roles/rbac/files/rbac-clusterrole.yaml
-apiVersion: rbac.authorization.k8s.io/v1beta1
+apiVersion: rbac.authorization.k8s.io/v1
```

### rbac cluster role binding aututorization apiVersion update (`v1`)

Observed error:
```
error: unable to recognize: no matches for kind "ClusterRoleBinding" in version "rbac.authorization.k8s.io/v1beta1"
```

Fix:

Kubernetes version `v1.23.1`+ no longer accepts `v1beta` for `rbac.authrization.k8s.io` version.
Update the rbac cluster role binding authorization configuration yaml to `v1`

``` diff
roles/rbac/files/rbac-clusterrole.yaml
-apiVersion: rbac.authorization.k8s.io/v1beta1
+apiVersion: rbac.authorization.k8s.io/v1
```


## unsolved errors

```
[INFO] plugin/ready: Still waiting on: "kubernetes"

W0130 reflector.go:324 pkg/mod/k8s.io/client-go@v0.23.1/tools/cache/reflector.go:167: failed to list *v1.EndpointSlice: endpointslices.discovery.k8s.io is forbidden: User "system:serviceaccount:kube-system:coredns" cannot list resource "endpointslices" in API group "discovery.k8s.io" at the cluster scope
E0130 reflector.go:138 pkg/mod/k8s.io/client-go@v0.23.1/tools/cache/reflector.go:167: Failed to watch *v1.EndpointSlice: failed to list *v1.EndpointSlice: endpointslices.discovery.k8s.io is forbidden: User "system:serviceaccount:kube-system:coredns" cannot list resource "endpointslices" in API group "discovery.k8s.io" at the cluster scope
```

```
master-1 kube-apiserver[]: E0130 authentication.go:63] "Unable to authenticate the request" err="invalid bearer token"
```

```
[WARNING][60] active_rules_calculator.go 326: Profile not known or invalid, generating dummy profile that drops all traffic. profileID="ksa.kube-system.coredns"

```
```
node-1 kubelet[]: E0130 driver-call.go:262] Failed to unmarshal output for command: init, output: "", error: unexpected end of JSON input
node-1 kubelet[]: W0130 driver-call.go:149] FlexVolume: driver call failed: executable: /usr/libexec/kubernetes/kubelet-plugins/volume/exec/nodeagent~uds/uds, args: [init], error: fork/exec /usr/libexec/kubernetes/kubelet-plugins/volume/exec/nodeagent~uds/uds: no such file or directory, output: ""
node-1 kubelet[]: E0130 plugins.go:752] "Error dynamically probing plugins" err="error creating Flexvolume plugin from directory nodeagent~uds, skipping. Error: unexpected end of JSON input"
```

```
[INFO][1] main.go 94: Loaded configuration from environment config=&config.Config{LogLevel:"info", WorkloadEndpointWorkers:1, ProfileWorkers:1, PolicyWorkers:1, NodeWorkers:1, Kubeconfig:"", DatastoreType:"etcdv3"}
[FATAL][1] main.go 107: Failed to start error=failed to build Calico client: could not initialize etcdv3 client: open /calico-secrets/etcd-cert: permission denied
```

### Avoid deleting all of `/bin` with unarchive

New in python3.8 ansible version 2.12 the unarchive module will happily delete (overwrite by removal)
existing directories.  This can be bad when we're extracting the containerd tar ball onto `/bin`

Normal tar execution doesn't delete the source directory
```
cd /
tar xvfz containerd-1.5.9-linux-amd64.tar.gz
bin/
bin/ctr
bin/containerd-shim-runc-v2
bin/containerd-shim-runc-v1
bin/containerd-shim
bin/containerd
```

Ansible says hold my beer

```
student@node-2:~$ ls -al /bin
total 98372
drwxr-xr-x  2 student admin     4096 Jan  5 17:35 .
drwxr-xr-x 20 root    root      4096 Jan 30 19:45 ..
-rwxr-xr-x  1 student admin 49259008 Jan  5 17:35 containerd
-rwxr-xr-x  1 student admin  6438912 Jan  5 17:35 containerd-shim
-rwxr-xr-x  1 student admin  8777728 Jan  5 17:35 containerd-shim-runc-v1
-rwxr-xr-x  1 student admin  8794112 Jan  5 17:35 containerd-shim-runc-v2
-rwxr-xr-x  1 student admin 27448416 Jan  5 17:35 ctr
```

Fix: 

```
+   extra_opts: ["--strip-components=1"]
```

### CoreDNS starts unsync'd

```
[WARNING] plugin/kubernetes: starting server with unsynced Kubernetes API
```


### Network setup failure on pods


``` log
  Warning  FailedCreatePodSandBox  3m34s                kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox "e647c56fc036f1926ccb665873b3653cde5cd6510bb17c649f05efd250cec12c": Unauthorized
  Warning  FailedCreatePodSandBox  3m18s                kubelet            (combined from similar events): Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox "da0bb6e5252f0d848ac32811ee027db0af9f71c27a5ac7e192a4d05cc4599edf": Unauthorized
```


``` log
2022-01-30 17:21:57.754 [ERROR][26729] plugin.go 121: Final result of CNI ADD was an error. error=Unauthorized
2022-01-30 17:21:57.914 [WARNING][26747] k8s.go 521: WorkloadEndpoint does not exist in the datastore, moving forward with the clean up ContainerID="da0bb6e5252f0d848ac32811ee027db0af9f71c27a5ac7e192a4d05cc4599edf" WorkloadEndpoint="node--3-k8s-coredns--66d5dc5c47--bl67p-eth0"
2022-01-30 17:21:58.017 [WARNING][26775] ipam_plugin.go 432: Asked to release address but it doesn't exist. Ignoring ContainerID="da0bb6e5252f0d848ac32811ee027db0af9f71c27a5ac7e192a4d05cc4599edf" HandleID="k8s-pod-network.da0bb6e5252f0d848ac32811ee027db0af9f71c27a5ac7e192a4d05cc4599edf" Workload="node--3-k8s-coredns--66d5dc5c47--bl67p-eth0"
```

https://projectcalico.docs.tigera.io/reference/resources/workloadendpoint



```
sudo journalctl -n 2000 -f | egrep -v "sudo|pam|sshd|systemd-logind|ansible|systemd\[1\]"
```

# s/master/controller/g
https://github.com/kubernetes/website/issues/6525

cannot change:
```
roles/calico/templates/calico.yaml.j2:        - key: node-role.kubernetes.io/master
roles/make_certs/templates/admin-csr.json.j2:      "O": "system:masters",
```
